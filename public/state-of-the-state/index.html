<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" State of the... state! &middot;  Misframe" />
  <meta property="og:site_name" content="Misframe" />
  <meta property="og:url" content="http://misfra.me/state-of-the-state" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:author" content="https://facebook.com/PreetamJinka" />
  
  <meta property="og:article:published_time" content="2013-12-17T00:00:00Z" />
  
  

  <title>
     State of the... state! &middot;  Misframe
  </title>

  <link rel="stylesheet" href="http://misfra.me/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://misfra.me/css/main.css" />
  <link rel="stylesheet" href="http://misfra.me/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://misfra.me/css/github.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="http://misfra.me/images/favicon.ico" />
  <link rel="apple-touch-icon" href="http://misfra.me/images/apple-touch-icon.png" />
  
</head>
<body>
  <header class="global-header">
    <section class="header-text">
      <h1><a href="http://misfra.me/">Misframe</a></h1>
      
      <div class="sns-links hidden-print">
  
  <a href="https://twitter.com/PreetamJinka" target="_blank">
      <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://facebook.com/PreetamJinka" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/PreetamJinka" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://jp.linkedin.com/in/preetamjinka" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
</div>

      
      <a href="http://misfra.me/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left"></i>
        &nbsp;Home
      </a>
      
      
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">State of the... state!</h1>
    <div class="post-meta clearfix">
      <div class="post-date pull-left">
        Posted on
        <time datetime="2013-12-17T00:00:00Z">
          Dec 17, 2013
        </time>
      </div>
      <div class="pull-right">
        
      </div>
    </div>
  </header>
  <section>
    

<p>Three months ago, I started working on <a href="https://github.com/PreetamJinka/fickle">fickle</a>, a key-value store written in Go. The point of this post is to just jot down some thoughts on where the project is right now and where I&rsquo;d like to take it.</p>

<h2 id="adversaria:f2cd37c860827c4af25243a3d0171392">Adversaria</h2>

<p>This all goes back to <a href="http://misfra.me/adversaria">Adversaria</a>. It&rsquo;s that small program I wrote in Java to help me log traffic. I use it in combination with a little <a href="http://www.flotcharts.org/">Flot</a> code to make pretty graphs:</p>

<p><img src="https://31.media.tumblr.com/81741791c5f33df8624d6fc250f88d7e/tumblr_inline_mxyoeqMxeh1rs73cz.png" alt="" />
</p>

<p>It&rsquo;s really simple, which is great, but it&rsquo;s also limited. It&rsquo;d be great to have something that looked as simple but with more functionality.</p>

<h2 id="fickle:f2cd37c860827c4af25243a3d0171392">Fickle</h2>

<p>This whole thing sort of came together as I went along. Here&rsquo;s a summary of what Fickle actually is:</p>

<ul>
<li>Ordered key-value store (I love these!)</li>
<li>In-memory</li>
<li>It has networking</li>
<li>Clients use a simple binary protocol</li>
<li>Fast reads since values are stored in a hash map</li>
</ul>

<h2 id="at-the-core:f2cd37c860827c4af25243a3d0171392">At the core</h2>

<p>Maps in Go are hash maps. I needed an ordered map (that&rsquo;s basically what a key-value store is). I had to write one: <a href="https://github.com/PreetamJinka/lexicon">Lexicon</a>. Lexicon uses another tiny <a href="https://github.com/PreetamJinka/orderedlist">package</a> I wrote, which introduces ordering to Go&rsquo;s <code>container/list</code> package.</p>

<p>This <em>entire</em> thing is built on top of Lexicon. Fickle is essentially a wrapper that exposes the Lexicon data structure over a network. <em>That&rsquo;s all.</em></p>

<h2 id="tests:f2cd37c860827c4af25243a3d0171392">Tests!</h2>

<p>This is one of the major reasons why I chose Go to write this stuff: tests are <em>easy</em>.  Here&rsquo;s what tests look like for Fickle:</p>

<pre><code>func Test1(t *testing.T) {
    i := NewInstance(&quot;:12345&quot;)
    go i.Start()
    time.Sleep(time.Millisecond * 100) // Wait for it to start up
    conn, err := net.Dial(&quot;tcp&quot;, &quot;:12345&quot;)
    if err != nil {
        t.Error(err)
    }
    write(conn, &quot;foo&quot;, &quot;bar&quot;)
    if !verify(conn) {
        t.Error(&quot;Bad write!&quot;)
    }
    if r := read(conn, &quot;foo&quot;); r != &quot;bar&quot; {
        t.Errorf(&quot;Bad read! Got %v&quot;, r)
    }
}
</code></pre>

<p>Start up an instance, open up a TCP connection, write and read from the connection, and print any errors that come up. It&rsquo;s not just the main program that has tests &ndash; its dependencies are also well-tested.</p>

<p>Not only that, all of these tests are run automatically at <a href="https://drone.io/">Drone</a> after every push to GitHub:
<img src="https://31.media.tumblr.com/0ae411257310108a4ba2272e2407676a/tumblr_inline_mxypyb0fxy1rs73cz.png" alt="" />
</p>

<p>Did I mention Drone is free for open-source projects?</p>

<h2 id="keeping-things-safe:f2cd37c860827c4af25243a3d0171392">Keeping things safe</h2>

<p>I don&rsquo;t want to lose my data, but as I mentioned, Fickle only stores data in memory. Everything is lost when the instance stops. Ouch!</p>

<p>There&rsquo;s two ways I can keep data: save it on the disk or have a replica. These aren&rsquo;t mutually exclusive. I actually had replication working earlier, but it was removed due to design changes.</p>

<p>The way I implemented replication was by broadcasting commands to replicas. Of course, this is incredibly trivial and doesn&rsquo;t guarantee consistency and many things can go wrong.</p>

<p>Saving to disk can also be trivial. I could just store a snapshot of the state and reload it, and I could also append a log of the operations sent to the database. The log would be &ldquo;replayed&rdquo; to restore data.</p>

<h2 id="transactions:f2cd37c860827c4af25243a3d0171392">Transactions</h2>

<p>I&rsquo;d love to add transactions to this. It&rsquo;s probably going to be incredibly difficult, but I shall try!</p>

<h2 id="looking-ahead:f2cd37c860827c4af25243a3d0171392">Looking ahead</h2>

<p>Have you seen this?
<img src="https://pbs.twimg.com/media/BbksqhsCIAASoUl.png:large" alt="" />
</p>

<p>It&rsquo;s a <a href="http://cubox-i.com/">CuBox-i</a>. It&rsquo;s a tiny ARM system that can have up to 4 cores and 2 GB of RAM. And it&rsquo;s not that expensive.</p>

<p>Here&rsquo;s an aside: I have a bunch of cPanel customers at <a href="https://bitcable.com/">Bitcable</a>, and I wanted to look at the distribution of MySQL database sizes. Here&rsquo;s what it looks like:
<img src="https://31.media.tumblr.com/63b2996bb8861072c304d4fcac2a10ef/tumblr_inline_mxyqoxzVFd1rs73cz.png" alt="" />
</p>

<p>Most are less than 99 MB! You could easily fit those into RAM, after accounting for overhead. It would be very realistic for me to, for example, put Misframe on a CuBox. I actually want to do that.</p>

<p>That&rsquo;s basically my goal for 2014: to get this key-value store to a point where I can depend on it to host my blog. It would also be cool to have a framework to test out interesting distributed computing things, like coordination protocols (eg. Paxos or Raft).</p>

  </section>
  <footer>
    <section class="author-info row">
      <div class="author-avatar col-md-2">
        
      </div>
      <div class="author-meta col-md-6">
        
        
      </div>
      
    </section>
    <ul class="pager">
      
      <li class="previous"><a href="http://misfra.me/types"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="next"><a href="http://misfra.me/dont-panic-type-assertion-safety">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'preetamjinka';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </footer>
</article>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      Copyright &copy; Preetam Jinka
    </div>
    <div class="sns-links hidden-print">
  
  <a href="https://twitter.com/PreetamJinka" target="_blank">
      <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://facebook.com/PreetamJinka" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/PreetamJinka" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://jp.linkedin.com/in/preetamjinka" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
</div>

  </footer>

  <script src="http://misfra.me/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37425054-1', 'auto');
    ga('send', 'pageview');
  </script>
  
  
</body>
</html>

