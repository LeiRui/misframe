<!DOCTYPE html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" Prepending to a file. &middot;  Misframe" />
  <meta property="og:site_name" content="Misframe" />
  <meta property="og:url" content="http://localhost:1313/prepending-file" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:author" content="https://facebook.com/PreetamJinka" />
  
  <meta property="og:article:published_time" content="2014-05-18T00:00:00Z" />
  
  

  <title>
     Prepending to a file. &middot;  Misframe
  </title>

  <link rel="stylesheet" href="http://localhost:1313/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/css/main.css" />
  <link rel="stylesheet" href="http://localhost:1313/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://localhost:1313/css/github.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="http://localhost:1313/images/favicon.ico" />
  <link rel="apple-touch-icon" href="http://localhost:1313/images/apple-touch-icon.png" />
  
</head>
<body>
  <header class="global-header">
    <section class="header-text">
      <h1><a href="http://localhost:1313/">Misframe</a></h1>
      
      <div class="sns-links hidden-print">
  
  <a href="https://twitter.com/PreetamJinka" target="_blank">
      <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://facebook.com/PreetamJinka" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/PreetamJinka" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://jp.linkedin.com/in/preetamjinka" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
</div>

      
      <a href="http://localhost:1313/" class="btn-header btn-back hidden-xs">
        <i class="fa fa-angle-left"></i>
        &nbsp;Home
      </a>
      
      
    </section>
  </header>
  <main class="container">


<article>
  <header>
    <h1 class="text-primary">Prepending to a file.</h1>
    <div class="post-meta clearfix">
      <div class="post-date pull-left">
        Posted on
        <time datetime="2014-05-18T00:00:00Z">
          May 18, 2014
        </time>
      </div>
      <div class="pull-right">
        
      </div>
    </div>
  </header>
  <section>
    <p>Prepending to a file is relatively expensive, but to what extent?
I decided to check. I wrote 2^23 integers to a file, in ASCII, separated
by a newline. On my ThinkPad with spinning rust, it takes a little longer
than 12 seconds. The file size is around 31 MB.</p>

<p>In order to &ldquo;prepend&rdquo; an integer to the beginning, we essentially have
to shift all of the other elements forward and then write what we need
at the beginning. So we write everything again, and then some. I wrote
a small Go program that does this, and here are the results:</p>

<pre><code>  âˆ‚ [-]: go run middle_insert.go 
Time to insert 4194304 integers: 12.202411374s
Time to prepend an int to the file: 579.472752ms
</code></pre>

<p>Prepending is 21 <em>times</em> faster! Dat cache.</p>

<p>A few notes worth mentioning:</p>

<ul>
<li>You have to be careful about overwriting, so you need to shift by
the byte-length of whatever you&rsquo;re prepending. Even if you&rsquo;re working in terms
of lines, files aren&rsquo;t.</li>
<li>You can shift byte-by-byte, but that&rsquo;s not how I/O works.</li>
<li>There&rsquo;s lots of stuff going on under-the-hood here. <span class='mono'>mmap</span> is a
complicated beast, in my opinion, and there are lots of gotchas.</li>
<li>I think the size of the prepended value is irrelevant.</li>
<li>All of the fancy stuff happens with <span class='mono'>syscall.Mmap()</span> and <span class='mono'>copy()</span>.
I thought this was an interesting use of slices!</li>
<li>Even though prepending is faster, you really are rewriting a bunch. Write amplification
should not be ignored here, and it&rsquo;s pretty significant (~16,000,000)!</li>
</ul>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;os&quot;
	&quot;syscall&quot;
	&quot;time&quot;
)

const N = 1 &lt;&lt; 22

func exitOnError(err error) {
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
}

func main() {
	f, err := os.Create(&quot;scratch.txt&quot;)
	exitOnError(err)
	defer f.Close()

	start := time.Now()
	// Write a bunch of ints
	for i := 1; i &lt;= N; i++ {
		fmt.Fprintln(f, i)
	}
	f.Sync()
	fmt.Println(&quot;Time to insert&quot;, N, &quot;integers:&quot;, time.Now().Sub(start))

	fStat, err := f.Stat()
	exitOnError(err)

	toBeInserted := fmt.Sprintln(0)

	start = time.Now()
	os.Truncate(f.Name(), fStat.Size()+int64(len(toBeInserted)))

	// Mmap! Let the OS do the work.
	sl, err := syscall.Mmap(int(f.Fd()), 0, int(fStat.Size())+len(toBeInserted),
		syscall.PROT_READ|syscall.PROT_WRITE, syscall.MAP_SHARED)
	exitOnError(err)

	// This feels like cheating :-P
	copy(sl, append([]byte(toBeInserted), sl...))
	f.Sync()
	syscall.Munmap(sl)
	fmt.Println(&quot;Time to prepend an int to the file:&quot;, time.Now().Sub(start))
}
</code></pre>

  </section>
  <footer>
  
    <ul class="pager">
      
      <li class="previous"><a href="http://localhost:1313/batching-channel-values"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="next"><a href="http://localhost:1313/appending-instead-of-prepending">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'preetamjinka';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </footer>
</article>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      Copyright &copy; Preetam Jinka
    </div>
    <div class="sns-links hidden-print">
  
  <a href="https://twitter.com/PreetamJinka" target="_blank">
      <i class="fa fa-twitter"></i>
  </a>
  
  
  <a href="https://facebook.com/PreetamJinka" target="_blank">
    <i class="fa fa-facebook"></i>
  </a>
  
  
  <a href="https://github.com/PreetamJinka" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://jp.linkedin.com/in/preetamjinka" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
</div>

  </footer>

  <script src="http://localhost:1313/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-37425054-1', 'auto');
    ga('send', 'pageview');
  </script>
  
  
</body>
</html>

